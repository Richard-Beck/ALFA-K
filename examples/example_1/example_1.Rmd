---
title: "Example 1"
author: "Richard J Beck"
date: "2023-10-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "~/projects/008_birthrateLandscape/ALFA-K/")
```

```{r}
source("utils/sim_setup_functions.R")
source("utils/analysis_functions_v2.R")
dir.create("examples/example_1/sim_output")
```
Setup ABM simulation with random fitness landscape

The gen_replicate() function can be used to setup the directory structure required to run an ABM simulation. 

Arguments

Nchrom: number of chromosomes for each cell in simulation
wavelength: controls complexity of GRF fitness landscape. Lower wavelengths are more complex. sweep_dir: output directory for sim
cpp_source: path to ABM executable
p=0.00005: missegregation rate

Value

cpp_run_cmd: command necessesary to run ABM simulation
sweep_id: name of output folder that has been generated


The following chunk sets up and runs ABM simulation:
```{r}
Nchrom <- 22
wavelength <- 0.8
misrate <- 0.00005
sweep_dir <- "examples/example_1/sim_output/"
cpp_source <- "ABM/bin/ABM.exe"
info <-  gen_replicate(Nchrom=Nchrom,wavelength = wavelength,p = misrate,sweep_dir = sweep_dir,cpp_source = cpp_source)
system(info$cpp_run_cmd)
```

Process output from ABM simulation:

The proc_sim() function compiles output from the ABM simulation into a format amenable to further analysis

Arguments

dir: directory containing csv output files from ABM simulation
times: numeric vector containing times to sample output from ABM simulation. For each user-supplied time supplied, the closest timepoint among ABM csv output files is selected. 

Value

x: matrix with rows corresponding to karyotypes and columns corresponding to timepoints. Values indicate the number of sampled cells. 

pop.fitness: growth rate of the sampled ABM population at each sampled timepoint 

dt: conversion factor between output timepoints and time in days. E.g. if dt=0.1, timepoint 400 = 40 days. 

clone.fitness: fitness of each karyotype in matrix x. values are ordered according to rows of x. 




```{r}
input_dir <- "examples/example_1/sim_output/N_22_w_0p8_m_0.00005_rep_00/train/00000/"
input_dir <- "../karyotype_evolution/ABM/output/nchrom_22_v2/N_22_w_0p8_rep_00/train/00000/"
x <- proc_sim(dir=input_dir,times = seq(0,2800,400))


```

Estimate fitness landscape:

```{r}
library(fields)
xo <- optimise_frequent_clones(x,min_obs = 20)
xn <- wrap_neighbor_fitness(x,xo,use_gdata = F,pm0 = 0.00005)
xo <- rbind(xo,xn)
xmat <- do.call(rbind,lapply(rownames(xo), function(i){
  as.numeric(unlist(strsplit(i,split="[.]")))
}))
y <- xo$f_est
fit <- Krig(xmat,y,m=1)
saveRDS(fit,"examples/example_1/sim_output/N_22_w_0p8_m_0.00005_rep_00/krig.Rds")

```

Convert Krig to format readable by ABM and save:
```{r}

knots <- fit$knots
cc <- fit$c
d <- fit$d
fscape <- rbind(cbind(knots,cc),c(d))
write.table(fscape, "examples/example_1/sim_output/N_22_w_0p8_m_0.00005_rep_00/fitted_landscape.txt",row.names = FALSE,col.names=FALSE,sep=",")

```

Generate a new config file to use fitted landscape. Run ABM.
```{r}

config <- readLines("examples/example_1/sim_output/N_22_w_0p8_m_0.00005_rep_00/config.txt")
config <- modify_config("fitness_landscape_type","krig",config)
config <- modify_config("fitness_landscape_file","examples/example_1/sim_output/N_22_w_0p8_m_0.00005_rep_00/fitted_landscape.txt",config)
config <- modify_config("output_dir","examples/example_1/sim_output/N_22_w_0p8_m_0.00005_rep_00/test",config)
writeLines(config,"examples/example_1/sim_output/N_22_w_0p8_m_0.00005_rep_00/fitted_landscape_config.txt")
system("ABM/bin/ABM.exe examples/example_1/sim_output/N_22_w_0p8_m_0.00005_rep_00/fitted_landscape_config.txt")
```

Run ABM with custom karyotype composition

```{r}
k1 <- rep(2,22)
k2 <- rep(4,22)
pop <- rbind(k1,k2)

n_init <- c(50000,50000)
pop <- cbind(pop,n_init)
write.table(pop,"examples/example_1/sim_output/N_22_w_0p8_m_0.00005_rep_00/custom_pop.txt",sep=",",row.names = F,col.names = F)

config <- readLines("examples/example_1/sim_output/N_22_w_0p8_m_0.00005_rep_00/config.txt")
config <- c(config,"population_file,examples/example_1/sim_output/N_22_w_0p8_m_0.00005_rep_00/custom_pop.txt")
config <- modify_config("output_dir","examples/example_1/sim_output/N_22_w_0p8_m_0.00005_rep_00/custom_pop",config)
writeLines(config,"examples/example_1/sim_output/N_22_w_0p8_m_0.00005_rep_00/custom_pop_config.txt")

system("ABM/bin/ABM.exe examples/example_1/sim_output/N_22_w_0p8_m_0.00005_rep_00/custom_pop_config.txt")
```

