---
title: "README"
author: "Richard J Beck"
date: "`r Sys.Date()`"
output:
  md_document:
    variant: markdown_github
---

Fitting ALFA-K model to Salehi data

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "~/projects/008_birthrateLandscape/ALFA-K/")
```

```{r}
source("utils/ALFA-K.R")
library(ggtree)
library(ape)
library(ggplot2)
```


Do CNA's have the same fitness effects despite different different karyotype backgrounds?


```{r}

cna_mat <- function(fi){
  xi <- readRDS(paste0("data/salehi/alfak_fits/minobs_5/",fi))

  fi <- do.call(rbind,lapply(row.names(xi$xv_res), function(i){
    yi <- gen_all_neighbours(i,remove_nullisomes = FALSE)
    nll <- apply(yi,1,function(yij) sum(yij<1)==0)
    #if(nrow(yi)<44) return(NULL)
    fi <- predict(xi$fit,yi)-xi$xv_res[i,"f_est"]
    fi <- c(fi)
    fi[!nll] <- NaN
    chrom <- stringr::str_pad(ceiling((1:length(fi))/2),width=2)
    mod <- rep(c("-","+"),22)
  
    names(fi) <- paste0(chrom,mod)
    fi
  }))
  rownames(fi) <- rownames(xi$xv_res)
  return(fi)
}

dvscor <- function(fi,method="manhattan",cormeth="pearson"){
  x <- cna_mat(fi)
  cormat <- cor(t(x),use = "complete",method = cormeth)
  d <- as.matrix(dist(do.call(rbind,lapply(rownames(x),s2v)),method=method))
  df <- data.frame(d=c(d[upper.tri(d)]),cor=c(cormat[upper.tri(cormat)]))
  return(df)
}


breakpoint_test <- function(df){
  d <- 1:50
  bptest <- sapply(d, function(di){
    nn <- sum(df$d==di)
    if(nn<3) return(NaN)
    t.test(df$cor[df$d==di],alternative = "greater")$p.value
  })
  
}

proc_id <- function(df){
  ids <- do.call(rbind,strsplit(df$ids,split="[.]"))
  ids0 <- ids
  are_equal <- ids[,1]==ids[,2]
  pdxlut <- m$PDX_id
  names(pdxlut) <- paste0("x",m$uid)
  ids[,1] <- pdxlut[paste0("x",ids[,1])]
  ids[,2] <- pdxlut[paste0("x",ids[,2])]
  pdx_equal <- ids[,1]==ids[,2]
  colnames(ids0) <- c("id1","id2")
  cbind(df,data.frame(pdx_equal,are_equal),ids0)
}

relablr <- function(id,meta,lid=NULL){
  id <- paste0("x",id)
  lut <- paste(meta$PDX_id,meta$timepoint,meta$linlab)
  names(lut) <- paste0("x",meta$uid)
  if(!is.null(lid)) lut <- paste0(lut,"[",lid,"]")
  lut[id]
}

find_passages <- function(nco,xi,return_names=F,all_candidates=F){
  li <- lineages[xi$lids]
  if(nco==1){
    c1 <- sapply(li,function(lii) lii$ids)
    i <- which.max(sapply(c1,length))
    if(return_names) return(names(li)[i])
    cx <- data.frame(comb=i,n=length(c1[[i]]),olap=FALSE,
                     npass=length(c1[[i]]-1),ids=i,nco=1)
    return(cx)
  }
  
  cx <- combn(1:length(li),nco)

  cx <- do.call(rbind,lapply(1:ncol(cx),function(i){
    cxj <- lapply(1:nrow(cx), function(j){
      li[[cx[j,i]]]$ids
    })
    n <- length(unique(unlist(cxj)))
    
    pj <- unlist(lapply(cxj,function(cxjk){
      sapply(2:length(cxjk), function(j) paste0(cxjk[j-1],".",cxjk[j]))
    }))
  
    olap <- length(pj)>length(unique(pj))
    npass <- length(unique(pj))
    data.frame(comb=i,n,olap,npass,ids=paste(cx[,i],collapse="."))
  }))
cx$nco <- nco
rownames(cx) <- NULL
if(nolaps) cx <- cx[!cx$olap,]
if(all_candidates) return(cx)
cx <- cx[cx$n==max(cx$n),]
cx <- cx[cx$npass==max(cx$npass),]

if(return_names){
  nms <- lapply(cx$ids,function(i){
    i <- as.numeric(unlist(strsplit(i,split="[.]")))
    names(li)[i]
  })
  return(nms)
}

return(cx)
}

```




Demonstrate the approach:


```{r}
xx <- readRDS("figures/salehi_data_fitting/fit_summaries.Rds")
xx <- xx[xx$min_obs==5&xx$r2>0.3,]
fi <- xx$filenames[12]#"SA609_X8_l_4_d1_1_d2_1.Rds"
x <- cna_mat(fi)
v <- do.call(rbind,lapply(rownames(x),s2v))
tree <- as.phylo(hclust(dist(v,method="euc")))
tree$tip.label <- rownames(x)
p <- ggtree(tree)
gheatmap(p,x, offset=1, width=5, font.size=2.5, 
         hjust=0.5)+
  scale_fill_viridis_c(expression(fitness~Delta))+
  coord_flip()

ggsave("figures/salehi_data_fitting/figures_post_jump/correlation_illustration.png",width=7,height=6,units="in")

```

3 comparisons - 
1. identical landscapes
2. different PDX
3. within PDX. 

1. identical landscapes

```{r}

xx <- readRDS("figures/salehi_data_fitting/fit_summaries.Rds")
xx <- xx[xx$min_obs==5&!xx$has_descendents&!xx$has_parents&xx$r2>0.3,]
ff <- xx$filenames

m <- read.csv("data/salehi/metadata.csv")

x <- do.call(rbind,lapply(ff, function(fi){
  xi <- dvscor(fi,method="manh",cormeth = "kendall")
  xi$fi <- fi
  xi
  }))

adf <- aggregate(list(cor=x$cor),by=list(d=x$d),mean,na.rm=T)
cdf <- aggregate(list(sig=x$cor),by=list(d=x$d),function(i){
  if(length(i)<3) return(1)
  t.test(i)$p.value
})
adf$pval <- cdf$sig
adf$sig <-adf$pval<0.01

p <- ggplot(x,aes(x=d,y=cor))+
  geom_jitter(height=0,width=0.3)+
  geom_errorbar(data=adf,aes(ymax=cor,ymin=cor,color=sig),size=2)+
  scale_x_continuous("manhattan distance",limits=c(-0.5,20.5))+
  scale_color_manual("P<0.01",values=c("blue","red"))+
  scale_y_continuous("Pearson coefficient")
p

ggsave("figures/salehi_data_fitting/figures_post_jump/cor_within_landscape.png",width=4.5,height=3,units="in")
```
2. Different PDX
```{r}


xx <- readRDS("figures/salehi_data_fitting/fit_summaries.Rds")
xx <- xx[xx$min_obs==5,]
xx <- xx[!xx$has_descendents&!xx$has_parents&xx$r2>0.2,]

ff <- xx$filenames

m <- read.csv("data/salehi/metadata.csv")





x <- lapply(ff,cna_mat)
ids <- unlist(lapply(1:length(x), function(i){
  uid <- xx$uid[xx$filenames==ff[i]]
  rep(uid,nrow(x[[i]]))
}))
x <- do.call(rbind,x)

cellLines <- sapply(ids, function(idi){
  m$PDX_id[m$uid==idi]
})

xc <- split(data.frame(x,check.names = F),f=cellLines)
xc <- do.call(rbind,lapply(xc,function(xci){
  data.frame(ids = colnames(xci),
             mn=apply(xci,2,mean,na.rm=T),
             md=apply(xci,2,median,na.rm=T),
             fpos=apply(xci,2,function(ii) mean(ii>0,na.rm=T)))
}))

x1 <- aggregate(list(fpos=xc$fpos),by=list(ids=xc$ids),function(ii) sum(ii>0.5))

cormat <- cor(t(x),use = "complete",method="kendall")
d <- as.matrix(dist(do.call(rbind,lapply(rownames(x),s2v)),method = "manhattan"))

mat <- do.call(rbind,lapply(1:length(ids), function(i) ids))
mat <- apply(mat,2,function(mi) paste0(mi,".",ids))

df <- data.frame(d=c(d[upper.tri(d)]),cor=c(cormat[upper.tri(cormat)]),ids=mat[upper.tri(mat)])



df <- proc_id(df)
df <- df[df$pdx_equal==FALSE,]
adf <- aggregate(list(cor=df$cor),by=list(d=df$d),mean,na.rm=T)
cdf <- aggregate(list(sig=df$cor),by=list(d=df$d),function(i){
  if(length(i)<3) return(1)
  t.test(i)$p.value
})
adf$pval <- cdf$sig
adf$sig <-adf$pval<0.01

p <- ggplot(df[df$pdx_equal==FALSE,],aes(x=d,y=cor))+
  geom_jitter(height=0,width=0.3)+
  geom_errorbar(data=adf,aes(ymax=cor,ymin=cor,color=sig),size=2)+
  scale_x_continuous("manhattan distance",limits=c(-0.5,20.5))+
  scale_color_manual("P<0.01",values=c("red","blue"))+
  scale_y_continuous("Pearson coefficient")
p

ggsave("figures/salehi_data_fitting/figures_post_jump/cor_across_pdx.png",width=4.5,height=3,units="in")
```



3a. within PDX (SA609)
```{r}
meta <- readRDS("figures/salehi_data_fitting/labelled_metadata.Rds")
m <- read.csv("data/salehi/metadata.csv")
xx <- readRDS("figures/salehi_data_fitting/fit_summaries.Rds")
xx <- xx[xx$min_obs==5&xx$r2>0.3,]

ff <- c("SA609UnBU_X7_l_6_d1_0_d2_0.Rds",
        "SA609R2_X7_l_7_d1_0_d2_0.Rds",
        "SA609_X10_l_8_d1_0_d2_0.Rds")

x <- lapply(ff,cna_mat)
ids <- unlist(lapply(1:length(x), function(i){
  uid <- xx$uid[xx$filenames==ff[i]]
  rep(uid,nrow(x[[i]]))
}))
x <- do.call(rbind,x)

cormat <- cor(t(x),use = "complete",method="kendall")
d <- as.matrix(dist(do.call(rbind,lapply(rownames(x),s2v)),method = "manhattan"))

mat <- do.call(rbind,lapply(1:length(ids), function(i) ids))
mat <- apply(mat,2,function(mi) paste0(mi,".",ids))

df <- data.frame(d=c(d[upper.tri(d)]),cor=c(cormat[upper.tri(cormat)]),ids=mat[upper.tri(mat)])

df <- proc_id(df)
df <- df[!df$are_equal,]

df$id1 <- relablr(df$id1,meta)
df$id2 <- relablr(df$id2,meta)
df$ids <- paste0(df$id1,"\n",df$id2)

df <- df[!df$ids=="SA609 X7 aaa\nSA609 X7 da",]

adf <- aggregate(list(cor=df$cor),by=list(d=df$d,ids=df$ids),mean,na.rm=T)
cdf <- aggregate(list(sig=df$cor),by=list(d=df$d,ids=df$ids),function(i){
  if(length(i)<3) return(1)
  t.test(i)$p.value
})
adf$pval <- cdf$sig
adf$sig <-adf$pval<0.01

p2 <- ggplot(df[!df$are_equal,],aes(x=d,y=cor))+
  facet_grid(rows=vars(ids))+
  geom_jitter(height=0,width=0.3)+
  geom_errorbar(data=adf,aes(ymax=cor,ymin=cor,color=sig),size=2)+
  scale_x_continuous("manhattan distance",limits=c(-0.5,20.5))+
  scale_color_manual("P<0.01",values=c("blue","red"))+
  scale_y_continuous("Pearson coefficient")
p2

ggsave("figures/salehi_data_fitting/figures_post_jump/cor_within_SA609.png",width=4.5,height=7.5,units="in")
```


```{r}

meta <- readRDS("figures/salehi_data_fitting/labelled_metadata.Rds")
xx <- readRDS("figures/salehi_data_fitting/fit_summaries_post_jump.Rds")
xx <- xx[xx$min_obs==5,]
ff <- c("SA535_CISPLATIN_CombinedU_X9_l_5_d1_0_d2_0.Rds",
        "SA535_CISPLATIN_CombinedT_X10_l_6_d1_0_d2_0.Rds")

#ff <- c("SA535_CISPLATIN_CombinedU_X9_l_5_d1_0_d2_0.Rds",
 #       "SA535_CISPLATIN_CombinedH_X8_l_4_d1_0_d2_0.Rds",
  #      "SA535_CISPLATIN_CombinedH_X10_l_4_d1_0_d2_0.Rds")

x <- lapply(ff,cna_mat)
ids <- unlist(lapply(1:length(x), function(i){
  uid <- xx$uid[xx$filenames==ff[i]]
  rep(uid,nrow(x[[i]]))
}))
x <- do.call(rbind,x)

cormat <- cor(t(x),use = "complete",method="kendall")
d <- as.matrix(dist(do.call(rbind,lapply(rownames(x),s2v)),method = "manhattan"))

mat <- do.call(rbind,lapply(1:length(ids), function(i) ids))
mat <- apply(mat,2,function(mi) paste0(mi,".",ids))

df <- data.frame(d=c(d[upper.tri(d)]),cor=c(cormat[upper.tri(cormat)]),ids=mat[upper.tri(mat)])

df <- proc_id(df)
df <- df[!df$are_equal,]

df$id1 <- relablr(df$id1,meta)
df$id2 <- relablr(df$id2,meta)
df$ids <- paste0(df$id1,"\n",df$id2)

adf <- aggregate(list(cor=df$cor),by=list(d=df$d,ids=df$ids),mean,na.rm=T)
cdf <- aggregate(list(sig=df$cor),by=list(d=df$d,ids=df$ids),function(i){
  if(length(i)<3) return(1)
  t.test(i)$p.value
})
adf$pval <- cdf$sig
adf$sig <-adf$pval<0.01



p2 <- ggplot(df[!df$are_equal,],aes(x=d,y=cor))+
  facet_grid(rows=vars(ids))+
  geom_jitter(height=0,width=0.3)+
  geom_errorbar(data=adf,aes(ymax=cor,ymin=cor,color=sig),size=2)+
  scale_x_continuous("manhattan distance",limits=c(-0.5,20.5))+
  scale_color_manual("P<0.01",values=c("blue","red"))+
  scale_y_continuous("Pearson coefficient")
p2

ggsave("figures/salehi_data_fitting/figures_post_jump/cor_within_SA535.png",width=4.5,height=3,units="in")
```
Follow up questions: 

1) Are a subset of chromosomes mostly responsible for the observed correlations?


```{r}




lineages <- readRDS("figures/salehi_data_fitting/lineages.Rds")
xx <- readRDS("figures/salehi_data_fitting/fit_summaries.Rds")
m <- read.csv("data/salehi/metadata.csv")
xx <- xx[xx$min_obs==5&xx$r2>0.3,]

ids <- sapply(xx$filename, function(fi) head(unlist(strsplit(fi,split=".R")),1))

xx <- xx[ids%in%names(lineages),]
ids <- ids[ids%in%names(lineages)]

lineages <- lineages[ids]

xx$pdx <- sapply(xx$uid,function(idi) m$PDX_id[m$uid==idi])
xx$lids <- ids

xx <- split(xx,f=xx$pdx)

nolaps <- TRUE



res <- lapply(xx,function(xi){

  df <- do.call(rbind,lapply(1:3,function(i){
    find_passages(nco = i,xi=xi)
  }))  
  best <- df[df$n==max(df$n),]
  best <- best[best$npass==max(best$npass),]
  best <- best[best$nco==min(best$nco),]
  i <- best$nco[1]
  ids <-  find_passages(nco = i,xi=xi,return_names = T)
  list(df=df,ids=ids)
})


ff <- do.call(rbind,lapply(1:length(res),function(i) {
  data.frame(file=paste0(res[[i]]$ids[[1]],".Rds"),pdx=xx[[i]]$pdx[1])
  }))

x <- lapply(ff$file,cna_mat)

df <- data.frame(do.call(rbind,lapply(x,function(xi){
  apply(xi,2,function(xij) mean(xij>0,na.rm=T))
})),check.names = F)

extremis <- apply(df,2,function(di) sum(di>0.5))
extr_lab <- extremis*0

extr_lab[extremis%in%c(0,6,7)] <- 1
z <- cbind(df,ff)
z <- reshape2::melt(z,id.vars=colnames(ff))

p <- ggplot(z,aes(x=variable,y=value,color=pdx))+
  geom_point()
p

p <- ggplot(z,aes(x=variable,y=value,color=extr_lab[variable]))+
  geom_point()
p

```

It occured to me to examine correlations directly on the closest karyotypes between two PDX. However this WILL NOT WORK because the karyotypes are too far apart and the Kriging returns basically a flat landscape outside the predicted region.

```{r}
meta <- readRDS("figures/salehi_data_fitting/labelled_metadata.Rds")
xx <- readRDS("figures/salehi_data_fitting/fit_summaries_post_jump.Rds")
xx <- xx[xx$min_obs==5,]
xx <- xx[!xx$has_descendents&!xx$has_parents&xx$r2>0.3,]
ff <- xx$filenames

x <- do.call(rbind,lapply(ff, function(fi){
  xi <- readRDS(paste0("data/salehi/alfak_fits_post_jump/minobs_5/",fi))
  k <- rownames(xi$xo[xi$xo$id=="fq",])
  uid <- xx$uid[xx$filenames==fi]
  pdx <- meta$PDX_id[meta$uid==uid]
  data.frame(k=k,pdx=pdx)
}))

x <- split(x,f=x$pdx)

x <- lapply(x, function(xi) do.call(rbind,lapply(unique(xi$k),s2v)))
ids <- unlist(lapply(names(x), function(id) rep(id,nrow(x[[id]]))))

x <- do.call(rbind,x)

d <- as.matrix(dist(x,method="manhattan"))
colnames(d) <- ids
rownames(d) <- ids

df <- reshape2::melt(d)

p <- ggplot(df,aes(x=d))+
  facet_grid(rows=vars(Var1),cols=vars(Var2))+
  geom_histogram()
p



```



Questions - What is the predicted distribution of fitness effects of CNA's? Is it different for low and high ploidy? PDX vs in-vitro? Treated vs untreated??

```{r}


assess_cna <- function(fi){
  uid <- x$uid[x$filenames==fi]
  pdx <- m$PDX_id[m$uid==uid]
  lab <- m$label[m$uid==uid]
  tp <- m$timepoint[m$uid==uid]
  xi <- readRDS(paste0("data/salehi/alfak_fits_post_jump/minobs_5/",fi))

  fi <- do.call(rbind,lapply(row.names(xi$xv_res), function(i){
   yi <- gen_all_neighbours(i,remove_nullisomes = FALSE)
    nll <- apply(yi,1,function(yij) sum(yij<1)==0)
  #if(nrow(yi)<44) return(NULL)
  fi <- predict(xi$fit,yi)-xi$xv_res[i,"f_est"]
  fi <- c(fi)
  fi[!nll] <- NaN
  chrom <- stringr::str_pad(ceiling((1:length(fi))/2),width=2)
  mod <- rep(c("-","+"),22)
  
  names(fi) <- paste0(chrom,mod)
  fi
}))

fi <- reshape2::melt(fi)
fi$pdx <- pdx
fi$tp <- tp
fi$lab <- lab
fi$uid <- uid
colnames(fi)[1:3] <- c("k","cna","deltaf")
return(fi)
}

m <- read.csv("data/salehi/metadata.csv")
favorites <- readRDS("data/salehi/favorites.Rds")
x <- readRDS("figures/salehi_data_fitting/fit_summaries_post_jump.Rds")
x <- x[x$min_obs==5&x$filenames%in%favorites&x$r2>0.3,]

ff <- x$filenames


df <- do.call(rbind,lapply(ff,assess_cna))
df$treatment_status <- sapply(df$uid, function(id){
  x$treatment_status[x$uid==id]
})

df$type <- "pdx"
df$type[df$pdx=="SA906"] <- "culture"

df_agg <- aggregate(list(var=df$deltaf),by=list(type=df$type,treatment=df$treatment_status),var,na.rm=T)

p <- ggplot(df,aes(x=deltaf))+
  facet_grid(rows=vars(type),scales="free_y")+
  geom_histogram(binwidth=0.02,boundary=0)+
  scale_x_continuous(expression(CNA~fitness~Delta),limits=c(-0.3,0.3))
p

ggsave("figures/salehi_data_fitting/figures_post_jump/deltaf_pdx_vitro.png",width=4,height=3,units="in")

lablr <- c(off="untreated",mixed="treated")
p <- ggplot(df[df$type=="pdx",],aes(x=deltaf))+
  facet_grid(rows=vars(lablr[treatment_status]),scales="free_y")+
  geom_histogram(binwidth=0.02,boundary=0)+
  scale_x_continuous(expression(CNA~fitness~Delta),limits=c(-0.3,0.3))
p
ggsave("figures/salehi_data_fitting/figures_post_jump/deltaf_treat_un.png",width=4,height=3,units="in")
```



