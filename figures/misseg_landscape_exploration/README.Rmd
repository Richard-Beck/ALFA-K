---
title: "Missegregation rate influences karyotype dominance"
output:
  pdf_document:
header-includes:
- \usepackage{caption}
- \captionsetup[figure]{labelformat=empty}
---


```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "~/projects/008_birthrateLandscape/ALFA-K/")
```

```{r,include=FALSE,eval=FALSE,echo=FALSE}
source("utils/ALFA-K.R")
source("utils/ode_functions.R")
library(ggplot2)
library(deSolve)
library(rootSolve)
transp <- function(x) as.numeric(gsub("p",".",x))
transpchar <- function(x) as.character(gsub("p",".",x))
linlabs <- c("SA535 X7 bb","SA906 X57 a")
linlabs <- c("scenario B","scenario A")
names(linlabs) <- c("SA535_CISPLATIN_CombinedH_X7_l_3_d1_0_d2_0",
               "SA906a_X57_l_7_d1_0_d2_0")
  
```

In most circumstances the fittest karyotype is expected to eventually become dominant within a population. We asked whether this status quo could be altered simply by changing the missegregation rate. We envisage two ways this could occur (Fig.6A): 1) karyotypes with more high-fitness neighbors should have an advantage when missegregation rate is high, since their numbers are bolstered by a continuous (albeit small) influx from their neighbors. 2) Low ploidy cells should have an advantange when missegregation rate is high, since their reduced total number of chromosomes mean a reduced per-cell risk of missegregation, so their populations should be more stable. Overall if the fittest karyotype has few neighbors or has high ploidy, it may not be dominant when the missegregation rate is high.  

To identify possible missegregation dependendent switches in karyotype distribution, we generated approximate transisition matrices connecting all karyotypes in the charted region of each ALFA-K fitted landscape. We then determined the dominant eigenvectors of these transition matrices at varying missegregation rates to find the steady state karyotype distributions. For a subset of fitted landscapes we indeed found a missegregation rate dependentent switch in karyotype distribution (Fig.6 B,C), where karyotypes that were fitter (Fig. 6 D,E) were dominant at lower missegregation rates but were displaced by less fit karyotypes at increasing missegregation rates. For SA906_x57_a the fitter group had significantly higher ploidy (Fig. 6F) but similar sized fitness peak to the less fit group (Fig. 6G), indicating that this was an example of a ploidy dependent frequency shift. For SA535_X7_bb both groups had similar ploidy (Fig. 6H) but the fitter group had less members (Fig. 6I), indicating that this was an example of peak size dependent freuqency shift. Finally, we simulated population evolution in our ABM as a validation of our transition matrix based approximation (Fig. 6J). Overall, these results identify two ways which missegregation rate can interact with fitness to determine clonal dominance and found evidence of their occurence in cultured cell lines.  




![Figure 6 Influence of missegregation rate on karyotype selection. A) Simple hyothetical example fitness landscapes where karyotype frequency dependends on missegregation rate. Karyotype frequency (point size) shifts from high to low ploidy (top row) or broader to narrower peaks (bottom row) as missegregation rate changes. (B,C) UMAPs showing the relative frequency of karyotypes representing at least 2% of the predicted steady-state population for SA906_x57_a (B) and SA535_X7_bb (C) at different missegregation rates. (D,E) ALFA-K estimated fitness of karyotypes shown in B-C  for SA906_x57_a (D) and SA535_X7_bb (E). F) ploidy and G) fitness distributions for the top 2% most frequent clones in SA906_x57_a. H) ploidy and I) fitness distributions for the top 2% most frequent clones in SA535_X7_bb. J) ABM simulation of karyotype evolution on fitted landscapes for SA906_x57_a and SA535_X7_b.  ](figure.png)

```{r,include=FALSE,eval=FALSE,echo=FALSE}

## ODE Model equation
chrmod <- function(time,state,parms){
  with(as.list(parms),{
    ds <- state%*%A
    ds <- ds-sum(ds)*state
    return(list(ds))
  })
}
reverse_state_index <- function(index,maxchrom,minchrom=1,ndim){
  ## reset maxchrom to behave as if minchrom was 1,1,...
  mc <- maxchrom-minchrom+1
  if(length(mc)==1 & ndim>1) mc <- rep(mc,ndim)
  ## how many elements does each part of the state represent?
  ## works as prod(numeric(0)) evaluates to 1:
  Nsites <- cumprod(mc)
  cp <- c(1,cumprod(mc)[-length(mc)])
  state <- c()
  for(j in ndim:1){
    ni <- floor((index-1)/cp[j])
    state <- c(ni+1,state)
    index <- index-cp[j]*ni
  }
  state + minchrom-1
}
pij<-function(i, j, beta){
  qij <- 0
  if(abs(i-j)>i){ ## not enough copies for i->j
    return(qij)
  }
  # code fails for j = 0, but we can get this result by noting i->0 always
  ## accompanies i->2i
  if(j==0) j <- 2*i
  s <- seq(abs(i-j), i, by=2 )
  for(z in s){
    qij <- qij + choose(i,z) * beta^z*(1-beta)^(i-z) * 0.5^z*choose(z, (z+i-j)/2)
  }
  ## if there is a mis-segregation: ploidy conservation implies that both daughter cells will emerge simultaneously
  #if(i!=j) qij <- 2*qij
  
  return(qij)
}

get_A <- function(maxchrom,beta){
 
  Ndim <- length(maxchrom)
  Nstates <- prod(maxchrom) 
  A<- matrix(0,nrow=Nstates,ncol=Nstates)
  for(i in 1:nrow(A)){
    state_i <- reverse_state_index(i,maxchrom,minchrom=1,ndim=Ndim)
    for(j in 1:nrow(A)){
      state_j <- reverse_state_index(j,maxchrom,minchrom=1,ndim=Ndim)
      qij <- sapply(1:Ndim, function(k) pij(state_i[k], state_j[k], beta))
      ## joint probability (i1,i2,...)->(j1,j2,...)
      qij <- prod(qij)
      A[i,j] <- 2*qij
      
      # ## case when there is no mis-segregation:
      if(i==j) A[i,j] <- (2*qij-1)
      
    }
  }
  A
}
get_fitness <- function(k,pk1,pk2){
  f1 <- as.numeric(sqrt(sum((k-pk1$centre)^2))<=pk1$rad)*pk1$fitness
  f2 <- as.numeric(sqrt(sum((k-pk2$centre)^2))<=pk2$rad)*pk2$fitness
  max(f1,f2)
}
mean_kary <- function(pm,pk1,pk2,return_df=FALSE){
  A <- get_A(maxchrom=c(8,8),beta=pm)
  state_ids <- do.call(rbind,lapply(1:nrow(A), reverse_state_index,maxchrom=c(8,8),ndim=2))
  f <- apply(state_ids,1,get_fitness,pk1=pk1,pk2=pk2)
  #f <- f/max(f)
  A <- A*f
  parms <- list(A=A)
  out <- runsteady(y=rep(1,length(f))/length(f),func=chrmod,parms=parms)
  df <- data.frame(state_ids)
  colnames(df) <- c("c1","c2")
  df$f <- f
  df$x <- out$y
  df$pm <- pm
  df$deltaf <- abs(pk1$fitness-pk2$fitness)
  if(!return_df) return(sum((df$c1)*df$x))
  if(!return_df) return(sum((df$c1+df$c2)*df$x/2))
  return(df)
  #data.frame(cn=1:8,f=f,pm=pm,deltaf=deltaf,x=out[nrow(out),-1])
}

```

```{r,include=FALSE,eval=FALSE,echo=FALSE}
pk1 <- list(centre=c(6,6),rad=1,fitness=1)
pk2 <- list(centre=c(3,3),rad=1,fitness=0.9)

df1 <- rbind(mean_kary(0.1,pk1,pk2,return_df = T),
            mean_kary(0.0001,pk1,pk2,return_df = T))
df1$id <- "scenario A"

pk3 <- list(centre=c(3,6),rad=0,fitness=1)
pk4 <- list(centre=c(6,3),rad=1.99,fitness=0.9)
df2 <- rbind(mean_kary(0.1,pk3,pk4,return_df = T),
            mean_kary(0.0001,pk3,pk4,return_df = T))
df2$id <-"scenario B"

df <- rbind(df1,df2)

df$pm[df$pm==0.0001] <- "0p0001"

pa <- ggplot(df,aes(x=c1,y=c2))+
  facet_grid(rows=vars(paste("misrate:",transpchar(pm))),cols=vars(id))+
  geom_raster(aes(fill=f))+
  geom_point(aes(size=x))+
  scale_color_manual("",values=c("black"))+
  scale_size("karyotype \nfrequency")+
  scale_fill_viridis_c("fitness",begin=0.1)+
  scale_x_discrete("chromosome 1 copy number")+
  scale_y_discrete("chromosome 2 copy number")+
  labs(tag="A")+
  theme_classic(base_size=8)
pa


#ggsave("figures/misseg_landscape_exploration/figures/example.png",width = 4,height=3,units="in")





```




```{r,include=FALSE,eval=FALSE,echo=FALSE}
## first generate the nonzero elements of the sparse transition matrices:
source("figures/misseg_landscape_exploration/sparseMatrixCoords.R")
## then find dominant eigenvalues at various missegregation rates:
source("figures/misseg_landscape_exploration/eigenScreen.R")

```


```{r,include=FALSE,eval=FALSE,echo=FALSE}
source("figures/misseg_landscape_exploration/sweep_abm_with_fits2.R")
```

```{r,include=FALSE,eval=FALSE,echo=FALSE}
screenR <- function(fi,p=c(0.001,0.005)){
  y <- readRDS(paste0("figures/misseg_landscape_exploration/coords/",fi))
  
  dims <- rep(length(y$kary),2)
  
  
  res <- do.call(cbind,lapply(p,function(p0){
    tm <- tmbuild(p0,y$coords,dims)
    
    func <- function(x, extra=NULL) { as.vector(tm %*% x) } 
    res <- arpack(func, options=list(n=dims[1], nev=1, ncv=3, which="LM",maxiter=10000), 
                  sym=FALSE, complex = FALSE)
    res <- abs(res$vectors)
   # res <- res/sum(res)
    names(res) <- y$kary
    res
  }))
  
  
  res <- res[order(rowSums(res),decreasing=T),]
   z <- res[apply(res,1,max)>0.02,]
  n0 <- z[,1]
  ni <- z[,2]
  n1 <- z[,ncol(z)]
  id <- n0>n1
  
  ntot <- n0 + n1
  n0 <- n0/ntot
  n1 <- n1/ntot
  
  fit <- readRDS(paste0("data/salehi/alfak_fits/minobs_5/",fi))$fit
  pts <- do.call(rbind,lapply(rownames(z),s2v))
  f <- predict(fit,pts)
 # ump <- umap::umap(pts)
  
  df <- data.frame(n0,ni,n1,id,f)
  #df <- cbind(ump$layout,df)
  #colnames(df)[1:2] <- c("u1","u2")
  
  return(df)
}
proc_res <- function(fi){
  print(fi)
  df <- screenR(paste0(fi,".Rds"))
  
  mr <- list.files(paste0(dir,fi))
  z <- do.call(rbind,pbapply::pblapply(mr,function(mri){
    reps <- list.files(paste0(dir,fi,"/",mri,"/output/"))
   # print(reps)
    do.call(rbind,lapply(reps,function(ri){
      x <- proc_sim(paste0(dir,fi,"/",mri,"/output/",ri,"/"),
                    times=c(seq(0,2500,250)))
      x <- x$x
      x <- x[order(rowSums(x),decreasing=T),]
      x <- data.frame(x,check.names = F)
      
      id <- rep("none",nrow(x))
      id[rownames(x)%in%rownames(df[df$id,])] <- "winlo"
      id[rownames(x)%in%rownames(df[!df$id,])] <- "winhi"
      
      z <- split(x,f=id)
      z <- do.call(rbind,lapply(z,colSums))
      for(i in 1:ncol(z)) z[,i] <- z[,i]/sum(z[c("winhi","winlo"),i])
      z <- reshape2::melt(z)
      colnames(z) <- c("id","time","n")
      z$rep <- ri
      z$misrate <- mri
      z
    }))
  }))
  z$cellLine <- fi
  return(z)
}

dir <- "data/salehi/misseg_landscape_exploration/minobs_5/"
ff <- c("SA535_CISPLATIN_CombinedH_X7_l_3_d1_0_d2_0",
               "SA906a_X57_l_7_d1_0_d2_0")#list.files(dir)

tst_files <- paste0(ff,".Rds")

df <- lapply(tst_files,function(fi) {
  tmp <- screenR(fi)
  list(winlo=rownames(tmp)[tmp$id],winhi=rownames(tmp)[!tmp$id])
  })
names(df) <- ff
saveRDS(df,"figures/misseg_landscape_exploration/peak_karyotypes.Rds")

z <- do.call(rbind,lapply(ff,proc_res))

saveRDS(z,file = "figures/misseg_landscape_exploration/screen_validation.Rds")

```




```{r}

frac_uncharted <- function(fi){
  print(fi)
  k <- readRDS(paste0("figures/misseg_landscape_exploration/coords/",
                      fi,".Rds"))$kary
  
  


  mr <- list.files(paste0(dir,fi))
  z <- do.call(rbind,pbapply::pblapply(mr,function(mri){
    reps <- list.files(paste0(dir,fi,"/",mri,"/output/"))
   # print(reps)
    do.call(rbind,lapply(reps,function(ri){
      x <- proc_sim(paste0(dir,fi,"/",mri,"/output/",ri,"/"),times=c(seq(0,10000,500)))$x
      xin <- x[rownames(x)%in%k,]
      f_in <- as.numeric(colSums(xin)/(colSums(x)))
      data.frame(f_in,t=colnames(x),rep=ri,misrate=mri)
    }))
  }))
  z$cellLine <- fi
  return(z)
}


dir <- "data/salehi/misseg_landscape_exploration/minobs_5/"
ff <- c("SA535_CISPLATIN_CombinedH_X7_l_3_d1_0_d2_0",
               "SA906a_X57_l_7_d1_0_d2_0")#list.files(dir)

z <- do.call(rbind,lapply(ff,frac_uncharted))
saveRDS(z,"figures/misseg_landscape_exploration/screen_validation_f_uncharted.Rds")
```

```{r}

options(scipen=999)
z <- readRDS("figures/misseg_landscape_exploration/screen_validation_f_uncharted.Rds")
cellLines <- c("SA535_CISPLATIN_CombinedH_X7_l_3_d1_0_d2_0",
               "SA906a_X57_l_7_d1_0_d2_0")
z2 <- z[z$cellLine%in%cellLines&z$misrate%in%c("0p0001","0p001","0p003"),]
z2$t <- as.numeric(z2$t)
ph <- ggplot(z2,aes(x=as.numeric(t)/10,y=f_in,
                    color=paste0("p=",transp(misrate))))+
  facet_grid(cols=vars(linlabs[cellLine]))+
 # geom_point()+
  stat_summary(size=0.5)+
  scale_y_log10("fraction charted")+
  scale_x_continuous("days",breaks=c(0,500,1000))+
  scale_color_viridis_d("",end=0.9,option="plasma")+
    theme_classic(base_size=8)+
    labs(tag="H")
ph
```

Compare theory to prediction 1 (steady-state)

```{r}

proc_abm_ss <- function(fi,df){
  tt <- 5000
  if(grepl("SA906",fi)) tt <- 1200
  pks <- df[[fi]]
  mr <- list.files(paste0(dir,fi))
  if(length(mr)==0) return(NULL)
  z <- do.call(rbind,pbapply::pblapply(mr,function(mri){
    reps <- list.files(paste0(dir,fi,"/",mri,"/output/"))
   # print(reps)
    do.call(rbind,lapply(reps,function(ri){
      print(ri)
      x <- proc_sim(paste0(dir,fi,"/",mri,"/output/",ri,"/"),
                    times=c(tt))
      xhi <- sum(x$x[rownames(x$x)%in%pks$winhi,])
      xlo <- sum(x$x[rownames(x$x)%in%pks$winlo,])
      xtot <- xhi+xlo
      z <- data.frame(fhi=xhi/xtot,flo=xlo/xtot,ntot=xtot)
      z$rep <- ri
      z$misrate <- mri
      z
    }))
  }))
  z$cellLine <- fi
  return(z)
}

get_theory_ss <- function(fi,df){
  pks <- df[[fi]]
  mr <- list.files(paste0(dir,fi))
  mr <- c("0p0004","0p001","0p002","0p003","0p005")
  y <- readRDS(paste0("figures/misseg_landscape_exploration/coords/",fi,".Rds"))
  cellLine <- fi
  cellLine <- as.character(linlabs[cellLine])
  dims <- rep(length(y$kary),2)
  
  p <- transp(mr)
  
  z <- do.call(rbind,lapply(mr,function(mri){
    p0 <- transp(mri)
    tm <- tmbuild(p0,y$coords,dims)
    func <- function(x, extra=NULL) { as.vector(tm %*% x) } 
    res <- arpack(func, options=list(n=dims[1], nev=1, ncv=3, which="LM",maxiter=10000), 
                  sym=FALSE, complex = FALSE)
    res <- abs(res$vectors)
   # res <- res/sum(res)
    names(res) <- y$kary
      xhi <- sum(res[pks$winhi])
      xlo <- sum(res[pks$winlo])
      xtot <- xhi+xlo
      z <- data.frame(fhi=xhi/xtot,flo=xlo/xtot,ntot=xtot)
      z$misrate <- mri
      return(z)
  }))
  z$cellLine <- fi
  return(z)
}

dir <- "data/salehi/misseg_landscape_exploration/latest_minobs_5/"
ff <- c("SA535_CISPLATIN_CombinedH_X7_l_3_d1_0_d2_0",
               "SA906a_X57_l_7_d1_0_d2_0")#list.files(dir)

df <- readRDS("figures/misseg_landscape_exploration/peak_karyotypes.Rds")

#z <- do.call(rbind,lapply(ff,proc_abm_ss,df=df))
za <- readRDS("figures/misseg_landscape_exploration/processed_swept_abm_with_fits_v2b.Rds")
zb <- readRDS("figures/misseg_landscape_exploration/processed_swept_abm_with_fits_v2.Rds")

zb <- zb[!(zb$cellLine%in%za$cellLine & zb$misrate%in%za$misrate),]
z <- rbind(za,zb)
z <- split(z,f=interaction(z$rep,z$misrate,z$cellLine))
z <- z[!sapply(z,nrow)==0]
names(z) <- NULL
z <- do.call(rbind,lapply(z,function(zi){
  tail(zi[zi$ntot>0,],1)
  
}))

z <- reshape2::melt(z,id.vars=c("ntot","rep","misrate","cellLine","time"))

z2 <- do.call(rbind,pbapply::pblapply(ff,get_theory_ss,df=df))
z2 <- reshape2::melt(z2,id.vars=c("ntot","misrate","cellLine"))

renamr <- c(SA535_CISPLATIN_CombinedH_X7_l_3_d1_0_d2_0="scenario B",
            SA906a_X57_l_7_d1_0_d2_0="scenario A")


pb <- ggplot(z,aes(x=transp(misrate),y=value,color=variable))+
  facet_grid(cols=vars(renamr[cellLine]))+
  geom_line(data=z2)+
  stat_summary(fun = median)+
  scale_x_log10("misseg. rate")+
  scale_y_continuous("population fraction")+
  scale_color_viridis_d("group",labels=c("x","y"),end=0.8)+
  theme_classic(base_size = 8)+
  labs(tag="B")
pb



```

Compare theory to prediction 2 (temporal)

```{r}

theory_pred <- function(fi,p0){
  p0_lab <- p0
  p0 <- transp(p0)
  k2 <- ""
  k4 <- ""
  if(fi=="SA906a_X57_l_7_d1_0_d2_0"){
    k2 <- "2.2.2.2.2.1.2.2.2.2.2.2.2.2.2.2.2.1.2.2.2.2"
    k4 <- "4.3.4.4.4.3.4.4.3.4.4.4.4.3.4.4.4.3.4.4.4.3"
  }
  if(fi=="SA535_CISPLATIN_CombinedH_X7_l_3_d1_0_d2_0"){
    k2 <- "3.4.5.2.2.4.5.2.2.2.3.2.2.2.2.1.3.2.4.4.3.2"
    k4 <- "3.4.5.2.2.2.6.2.2.3.3.3.2.2.2.1.3.3.4.4.3.2"
  }
  
  df <- screenR(paste0(fi,".Rds"))
  y <- readRDS(paste0("figures/misseg_landscape_exploration/coords/",fi,".Rds"))
  cellLine <- fi
  cellLine <- as.character(linlabs[cellLine])
  dims <- rep(length(y$kary),2)
  
  tm <- tmbuild(p0,y$coords,dims)
  
  eulerStep <- function(xi,dt=1){
    xi <- xi+tm%*%xi*dt
    xi <- xi/sum(xi)
    return(xi)
  }
  
  x0 <- rep(0,length(y$kary))
  x0[which(y$kary%in%c(k2,k4))] <- 1
  x <- x0/sum(x0)
  
  res <- data.frame(winlo=NULL,winhi=NULL)
  
  dt <- 1
  for(i in 1:300) {
    x <- eulerStep(x,dt)
    z1 <- x[y$kary%in%rownames(df[df$id,])]
    z2 <- x[y$kary%in%rownames(df[!df$id,])]
    ntot <- sum(z1)+sum(z2)
    res <- rbind(res,data.frame(winlo=sum(z1)/ntot,winhi=sum(z2)/ntot))
  }
  
  res$time <- (1:nrow(res)-1)*dt
  
  res <- reshape2::melt(res,id.vars="time")
  res$cellLine <- fi
  res$misrate <- p0_lab
  return(res)
}

```

```{r,include=FALSE,eval=FALSE,echo=FALSE}

z <- readRDS("figures/misseg_landscape_exploration/screen_validation.Rds")
cellLines <- c("SA535_CISPLATIN_CombinedH_X7_l_3_d1_0_d2_0",
               "SA906a_X57_l_7_d1_0_d2_0")
#cellLines <- cellLines[2]
mr <- c("0p0001","0p001","0p003")
#mr <- c("0p0001","0p005")
z2 <- z[!z$id=="none"&z$cellLine%in%cellLines&z$misrate%in%mr,]

z3 <- do.call(rbind,lapply(cellLines,function(fi){
  do.call(rbind,lapply(mr,function(p0){
    print(p0)
    theory_pred(fi,p0)
  }))
}))



#z2 <- z2[!(z2$misrate=="0p003"&z2$time>4000),]

pb <- ggplot(z2,aes(x=time/10,y=n,color=id))+
  facet_grid(rows=vars(paste0("misrate=",transpchar(misrate))),cols=vars(linlabs[cellLine]),
             scales="free")+
  stat_summary(size=0.5)+
  geom_line(data=z3,aes(x=time,y=value,color=variable))+
  #scale_y_log10("num. cells",limits=c(.01,1))+
  scale_x_continuous("days")+
  scale_color_viridis_d("group",labels=c("x","y"),end=0.8)+
    theme_classic(base_size=8)+
    labs(tag="B")
pb
#ggsave("figures/misseg_landscape_exploration/figures/abm_test.png",width=5,height=3,units="in")

```

```{r}

proc_screen <- function(fi){
  y <- readRDS(paste0("figures/misseg_landscape_exploration/coords/",fi))
  cellLine <- head(unlist(strsplit(fi,split=".Rds")),1)
  cellLine <- as.character(linlabs[cellLine])
  dims <- rep(length(y$kary),2)
  
  p <- c(0.0001,0.001,0.003,0.005)
  res <- do.call(cbind,lapply(p,function(p0){
    tm <- tmbuild(p0,y$coords,dims)
    func <- function(x, extra=NULL) { as.vector(tm %*% x) } 
    res <- tryCatch(expr = {
      res <- arpack(func, options=list(n=dims[1], nev=1, ncv=3, which="LM",maxiter=5000), 
                    sym=FALSE, complex = FALSE)
      res <- abs(res$vectors)
    },error=function(e) return(rep(0,nrow(tm))))
    
    names(res) <- y$kary
    res
  }))
  
  res <- res[order(rowSums(res),decreasing=T),]
  z <- res[apply(res,1,max)>0.02,]
  n0 <- z[,1]
  n1 <- z[,4]
  
  
  fit <- readRDS(paste0("data/salehi/alfak_fits/minobs_5/",fi))$fit
  pts <- do.call(rbind,lapply(rownames(z),s2v))
  f <- predict(fit,pts)
  ump <- umap::umap(pts)
  
  df <- data.frame(n0,n1,f)
  df <- cbind(ump$layout,df)
  colnames(df)[1:2] <- c("u1","u2")
  
  df$ploidy <- sapply(rownames(df), function(k) mean(s2v(k)))
  df$id <- df$n0>df$n1
  
  
  
  z <- reshape2::melt(df,measure.vars=c("n0","n1"))
  z$cellLine <- cellLine
  df$cellLine <- cellLine
  return(list(z=z,df=df))
}
options(scipen = 0)
z1 <- proc_screen("SA906a_X57_l_7_d1_0_d2_0.Rds")
z2 <- proc_screen("SA535_CISPLATIN_CombinedH_X7_l_3_d1_0_d2_0.Rds")

z <- rbind(z1$z,z2$z)
df <- rbind(z1$df,z2$df)

relablr <- c(n0='misrate=0.0001',n1='misrate=0.005')
pc <- ggplot(z,aes(x=u1,y=u2,color=value,shape=id))+
  facet_grid(cols=vars(cellLine),rows=vars(relablr[variable]),scales="free")+
    geom_point(size=0.6)+
    scale_color_viridis_c("steady\n-state\nfreq.",trans="log",breaks=c(1e-1,1e-5,1e-9,1e-13,1e-17))+
    scale_x_continuous("umap1")+
    scale_y_continuous("umap2")+
    scale_shape_discrete("group",labels=c("x","y"))+
    theme_classic(base_size=8)+
    labs(tag="C")+
    theme(legend.key.size = unit(0.1,"in"))
pc
  
pe <- ggplot(z2$df,aes(x=u1,y=u2,color=f,shape=id))+
    facet_grid(cols=vars(cellLine),scales="free")+
    geom_point(size=0.4)+
    scale_color_viridis_c("fitness")+
    scale_x_continuous("umap1")+
    scale_y_continuous("umap2")+
    scale_shape_discrete("group",labels=c("x","y"))+
    theme_classic(base_size=8)+
    labs(tag="E")+
    theme(legend.key.size = unit(0.1,"in"))
pe
  
  pd <- ggplot(z1$df,aes(x=u1,y=u2,color=f,shape=id))+
    facet_grid(cols=vars(cellLine),scales="free")+
    geom_point(size=0.4)+
    scale_color_viridis_c("fitness")+
    scale_x_continuous("umap1")+
    scale_y_continuous("umap2")+
    scale_shape_discrete("group",labels=c("x","y"))+
    theme_classic(base_size=8)+
    labs(tag="D")+
    theme(legend.key.size = unit(0.1,"in"))
  pd
  
  pf <- ggplot(df,aes(x=ploidy,fill=id))+
    facet_grid(cols=vars(cellLine),scales="free")+
    geom_histogram(position="dodge",bins = 10)+
    scale_fill_viridis_d("group",labels=c("x","y"),end=0.8)+
    scale_x_continuous("ploidy")+
    theme_classic(base_size=8)+
    labs(tag="F")+
    theme(legend.key.size = unit(0.1,"in"))
  pf
  
  pg <- ggplot(df,aes(x=f,fill=id))+
    facet_grid(cols=vars(cellLine),scales="free")+
    geom_histogram(position="dodge",bins=10)+
    scale_fill_viridis_d("group",labels=c("x","y"),end=0.8)+
    scale_x_continuous("fitness")+
    theme_classic(base_size=8)+
    labs(tag="G")+
    theme(legend.key.size = unit(0.1,"in"))
  pg

```


```{r,include=FALSE,eval=FALSE,echo=FALSE}
options(scipen = 0)
library(gridExtra) 

c1 <- grid.arrange(pa,pc,ncol=1,heights=c(1,1))
c2 <- grid.arrange(pb,grid.arrange(pd,pe,ncol=2),pf,pg,ncol=1,heights=c(1,1,1,1))

plt <- grid.arrange(c1,c2,nrow=1,widths=c(1.2,1))
ggsave("figures/misseg_landscape_exploration/figure.png",plot=plt,width=8,height=8,units="in")
```