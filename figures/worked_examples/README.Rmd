---
title: "README"
author: "Richard J Beck"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir="~/projects/008_birthrateLandscape/ALFA-K/")
```

2 modes of failure:

1) No evolution
2) No enough samples

We will explore what happens when there are not enough samples first.

```{r}
root.dir <- "data/main/"
sweepID <- "N_22_w_1p6_m_0.00005_rep_08"
dir <- paste0(root.dir,sweepID,"/")

z <- readRDS("tests/data/pearsonR.Rds")
z <- z[z$id1==sweepID,]
z <- z[grepl("_10_",z$id2),]

id <- z$id2[1]
fit_obj <- readRDS(paste0(dir,"sweep_fits/",id,".Rds"))
fobj <- gen_fitness_object(paste0(dir,"/config.txt"), paste0(dir,"/landscape.txt"))
k <- head(rownames(fit_obj$xo),5)
kmat <- do.call(rbind,lapply(k,s2v))
ftru <- apply(kmat,1,getf,fobj=fobj)


q <- lapply(z$id2,function(id){
  ntp <- as.numeric(unlist(strsplit(id,"_"))[4])
  fit_obj <- readRDS(paste0(dir,"sweep_fits/",id,".Rds"))
  data_obj <- proc_sim(paste0(dir,"train/00000/"),seq(0,2000,length.out=ntp))
  q <- melt_for_plotting(data_obj=data_obj,karyotypes = k,fit_obj = fit_obj)
  q$est <- data.frame(f_est=fit_obj$xo[k,]$f_est,f_tru=ftru,ntp=ntp)
  q$data$ntp <- ntp
  q$fit$ntp <- ntp
  q
})

qdata <- do.call(rbind,lapply(q,function(qi) qi$data))
qfit <- do.call(rbind,lapply(q,function(qi) qi$fit))
qest <-  do.call(rbind,lapply(q,function(qi) qi$est))

```

In this figure we're comparing a situation where we sample the same ABM experiment at either 2,4,or 8 timepoints. Key points:
1) Note all of the fits to the available data are good.
2) Clearly with 2 timepoints the fit is underconstrained. 
 
```{r}

p1 <- ggplot(qdata,aes(x=time,y=frequency,color=karyotype))+
  facet_wrap(~ntp)+
  geom_point(size=2)+
  geom_line(data=qfit)+
  theme_classic(base_size=12)
p1

```

As we examine the clone fitness estimates resulting from the fit we notice:
1) for 2 timepoints case there are two clumps of fitness estimates - 1 of clones present at initial timepoint (in this case a single, diploid clone), another of the clones that emerge at later timepoints.
2) Adding more timepoints the fitness estimates correlate better with the true fitness.
3) Note in the 4 timepoints case the bad estimate - results from the underconstrained clone that is emerging at the final timepoint. Going from 4-8 timepoints one can observe how this clone fitness is better constrained.


```{r}

p2 <- ggplot(qest,aes(x=f_est,y=f_tru,color=as.character(ntp)))+
  theme_classic(base_size=12)+
  geom_abline(intercept=0.28)+
  geom_jitter(height=0.002,width=0.002,size=2)
p2
```

```{r}


root.dir <- "data/main/"
sweepID <- "N_22_w_1p6_m_0.00005_rep_08"
dir <- paste0(root.dir,sweepID,"/")

z <- readRDS("tests/data/pearsonR.Rds")
z <- z[z$id1==sweepID,]
z <- z[grepl("_10_",z$id2),]

fobj <- gen_fitness_object(paste0(dir,"/config.txt"), paste0(dir,"/landscape.txt"))



q <- do.call(rbind,lapply(z$id2,function(id){
  ntp <- as.numeric(unlist(strsplit(id,"_"))[4])
  fit_obj <- readRDS(paste0(dir,"sweep_fits/",id,".Rds"))
  q <- fit_obj$xo
  q$id2 <- ntp
  v <- do.call(rbind,lapply(rownames(q),s2v))
  q$ftru <- apply(v,1,getf,fobj=fobj)
  q
}))

p <- ggplot(q,aes(x=f_est,y=ftru,color=id))+
  facet_grid(cols=vars(id2),scales="free")+
  geom_point()+
  geom_point(data=q[q$id=="fq",])+
  geom_abline(intercept=0.28)
p


```

Seems like something is different about our neighbor fitness estimation that means our old result is not reproducible. Plus side - new result looks better. Guess we better rerun.

```{r}

root.dir <- "data/main/"
sweepID <- "N_22_w_1p6_m_0.00005_rep_08"
dir <- paste0(root.dir,sweepID,"/")

z <- readRDS("tests/data/pearsonR.Rds")
z <- z[z$id1==sweepID,]
z <- z[grepl("_10_",z$id2),]

id <- z$id2[1]
ntp <- as.numeric(unlist(strsplit(id,"_"))[4])

x <- proc_sim(paste0(dir,"train/00000/"),seq(0,2000,length.out=ntp))

misseg_rate<- 0.00005

fit_obj <- readRDS(paste0(dir,"sweep_fits/",id,".Rds"))

x0 <- fit_obj$xo[fit_obj$xo$id=="fq",]
x1 <- wrap_neighbor_fitness(x,x0,pm0=misseg_rate)
x1_ <- fit_obj$xo[fit_obj$xo$id=="nn",]
```

