---
title: "Manager"
output: html_document
date: "2023-11-13"
# Basic workflow consists of: 
# 1) using ALFA-K to infer multiple karyotype fitness landscapes  
# 2) dimensionality reduction to view all available landscapes combined 
# 3) locating a given set of karyotypes onto those landscapes 
# 4) Forward sims to compare the evolutionary trajectory taken by different initial karyotype configurations across the different landscapes
# 5) Testing if the predicted evolution correlates with clinical variables (such as pathological stage)
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir="~/projects/008_birthrateLandscape/ALFA-K/")
```

```{r}
source("utils/comparison_functions.R")
```

```{r}


dir<- "figures/melanoma_GSE174401/numbat_output/"
ff <- list.files(dir)
ff <- ff[grepl("RObj",ff)]

df <- do.call(rbind,lapply(ff, function(fi){
  load(paste0(dir,fi))
  x <- karyo_in
  data.frame(id=fi,rows=nrow(x),cols=ncol(x),n5 = sum(rowSums(x)>4))
}))


df <- df[df$cols>1,]
ff <- df$id
m <- read.csv("figures/melanoma_GSE174401/updated_metadata.csv")

lapply(ff, function(fi){
  load(paste0(dir,fi))
  x <- karyo_in
  date <- m$Date.Collected.relative.to.death
  date[is.na(date)] <- m$Date.Collected.relative.to.last.contact[is.na(date)]
  tt <- -sapply(colnames(x), function(ci){
   date[m$Sample.ID.as.it.appears.in.SCIVA==ci]
  })
  tt <- tt - min(tt)
  colnames(x) <- tt
  x <- x[,order(as.numeric(colnames(x)))]
  x <- list(x=x, pop.fitness=NULL,dt=1)
  id <- unlist(strsplit(fi,split=".R"))[1]
  saveRDS(x,paste0(dir,"../alfak_input/",id,".Rds"))
  return(0)
})

```


```{r}

dir <- "figures/melanoma_GSE174401/fits/"

ff <- list.files(dir)

x <- do.call(rbind,lapply(ff, function(fi) {
  print(fi)
xi <- readRDS(paste0(dir,fi))
xi <- xi[!sapply(xi,is.null)]
if(length(xi)==0) return(NULL)
cor<-sapply(xi, function(xij) xij$vx_cor)
Rsq<-sapply(xi, function(xij) {
  xij$xv_res <- xij$xv_res[!is.na(xij$xv_res$f_xv),]
  if(nrow(xij$xv_res)<2) return(-Inf)
  R2(xij$xv_res$f_est,xij$xv_res$f_xv)
})
n <-sapply(xi, function(xij) nrow(xij$xv_res))

goodness <- Rsq*n

j <- which.max(goodness)

df <- data.frame(cor=cor[j],
                 R2 = Rsq[j],
                 n=n[j],
                 id=unlist(strsplit(fi,split=".Rds"))[1])
}))

```

```{r}


load(paste0(dir,"PatientB.RObj"))
x <- karyo_in
colnames(x) <- c(0,28,58)
x <- list(x=x, pop.fitness=NULL,dt=1)
saveRDS(x,"data/patients/Melanoma_GSE174401/alfak_inputs/PatientB.Rds")

source("code/ALFA-K.R")

opt <- alfak(x,min_obs = 5)

xfq <- opt$xo[opt$xo$id=="fq",]

loo <- lapply(1:nrow(xfq), function(i){
  optim_loo(i,x,xfq)
})

loo <- unlist(loo)

xfq$f_xv <- as.numeric(loo)
plot(xfq$f_est,xfq$f_xv,xlab='XV prediction',ylab='alfaK prediction')
R2(xfq$f_est,xfq$f_xv)
R2(xfq$f_est[],xfq$f_xv)
```

Load libraries and datasets
```{r cars}
source("Utils.R")
source("viewKaryotypeFitnessLandscape.R")
library(matlab)
library(ggplot2)
library(rgl)
source("~/Repositories/ALFA-K/utils/sim_setup_functions.R")
source("~/Repositories/ALFA-K/utils/ALFA-K.R")
## melanoma patients of interest (with sufficient data for inference with ALFAK):
mpoi=c("Patient10" , "PatientB"  ,  "PatientE"); 
cnvLandscape_tnbc=read.table(file="../data/patients/TCGA/TNBC/cnvLandscapeTCGA_tnbc.txt",sep="\t",header=T,check.names=F)
ALFAK_SIMS="../data/patients/TCGA/TNBC/A01_ALFAK_Sims"
dir.create(ALFAK_SIMS)
```

Postprocess Numbat output as input for ALFA-K:
```{r}
## 
melanoma_path2karyo=NumbatPostProcess(DATASETID="Melanoma_GSE174401")
# hnsc_path2karyo=NumbatPostProcess(DATASETID="HNSC_GSE181919")

```

Predict karyotype fitness lanscape:
```{r}
for(input in melanoma_path2karyo){
  input_=gsub(".RObj","",input)
  print(input_)
  dir.create(input_)
  load(input); ## loads obj. "karyo_in"
  dt=5; ##@TODO: read from metadata
  colnames(karyo_in)=seq(dt,dt*ncol(karyo_in),by=dt)
  try(detach("package:matlab", unload=TRUE),silent = T)
  opt <- alfak(list(x=karyo_in, pop.fitness=NULL,dt=dt),min_obs = 2)
  ## Run ALFA-K --> one folder per patient
  saveRDS(opt$fit,paste0(input_,matlab::filesep,"krig.Rds"))
  saveRDS(opt$xo,paste0(input_,matlab::filesep,"frequent_clones.Rds"))
}

melanoma=list.dirs("../data/patients/Melanoma_GSE174401/ALFAK_fitnessLandscape",full.names = T,recursive = F)
names(melanoma)=sapply(melanoma, function(x) matlab::fileparts(x)$name)

# tnbc=list.dirs("../data/cellLinesXenograftsAndOrganoids/BreastCancer/ALFAK_fitnessLandscape",full.names = T,recursive = F)
# names(tnbc)=sapply(tnbc, function(x) matlab::fileparts(x)$name)
```


Melanoma -- Gather all available landscapes:
```{r}

landscape=list()
for(p in melanoma[mpoi]){
    print(p)
    landscape[[matlab::fileparts(p)$name]] = viewKaryotypeFitnessLandscape(p , withumap=F)
}

## Also include karyotypes from other patients
minF=mean(sapply(landscape, function(x) quantile(x$f,0.5)),na.rm=T)
for(patient in setdiff(names(melanoma_path2karyo), names(landscape))){
  load(melanoma_path2karyo[[patient]]); ## loads obj. "karyo_in"
  k=sapply(rownames(karyo_in), function(x) as.numeric(strsplit(x,".", fixed=T)[[1]]))
  rownames(k)=1:22
  colnames(k)=paste0(patient,".X",1:ncol(k))
  landscape[[patient]] = list(k = t(k), f=repmat(minF,nrow(k),1) )
  ## print minimum distance to either of the mpoi landscapes:
  dd=sapply(landscape[mpoi], function(x) flexclust::dist2(x$k, landscape[[patient]]$k, method = "manhattan"))
  dd=sapply(dd,function(x)  apply(x,2,min), simplify = F)
  dd= dd[which.min(sapply(dd, mean))]
  print(paste(patient,"-->", names(dd), "; dist. range", paste(range(dd),collapse = "-")))
}
```


Melanoma: View all available landscapes combined:
```{r}
k = do.call(rbind,sapply(landscape, function(x) x$k, simplify = F))
f = do.call(rbind,sapply(landscape, function(x) x$f))
pc=umap::umap(k,n_components=2,min_dist=0.9)
## color-code karyotypes in umap by landscape membership
f_col=sample(rainbow(length(landscape)))
f_col=sapply(1:length(landscape), function(x) rep(f_col[x], length(landscape[[x]]$f)))
f_col=do.call(c,f_col)
op=sapply(setdiff(names(landscape),mpoi), function(x) grep(paste0(x,"."),rownames(k), fixed = T) )
op=do.call(c, op); ## other patients (not mpoi)
## 2D
plot(pc$layout[-op,],col =f_col[-op],pch=20,cex=0.175,main=what, xlab="", ylab="")
points(pc$layout[op,],col =f_col[op],pch=20,cex=2)
legend("bottomleft", legend = names(landscape)[-length(landscape)], pch = 16, col = unique(f_col), cex=1)

# save(file="~/Downloads/pca_melanoma.RObj",list = c("pc"))
```



Breast cancer -- Gather all available landscapes:
```{r}
landscape=list()
for(p in tnbc){
  print(p)
  landscape[[fileparts(p)$name]] = viewKaryotypeFitnessLandscape(p, withumap=F)
}

## Also include tcga TNBC karyotypes
minF=mean(sapply(landscape, function(x) quantile(x$f,0.5)),na.rm=T)
landscape[['TCGA']]=list(k=round(cnvLandscape_tnbc), f=repmat(minF,nrow(cnvLandscape_tnbc),1))
```


Breast cancer: View all available landscapes combined:
```{r}
landscape = landscape[c("hTERTa" ,  "hTERTb" , "SA535"  ,   "SA609ln1", "TCGA" )]
k = do.call(rbind,sapply(landscape, function(x) x$k, simplify = F))
f = do.call(rbind,sapply(landscape, function(x) x$f))
pc=umap::umap(k,n_components=2,min_dist=0.9)
## color-code karyotypes in umap by landscape membership
f_col=sapply(1:length(landscape), function(x) rep(x, length(landscape[[x]]$f)))
f_col = list(sample=do.call(c,f_col))
## color-code karyotypes in umap by predicted fitness
f_col_=f*100
f_col[["fitness"]] = 1+ f_col_- min(f_col_)
## color-code karyotypes in umap by ploidy
f_col_=sapply(1:length(landscape), function(x) round(apply(landscape[[x]]$k,1,mean)*5)/5 )
f_col[["ploidy"]] = do.call(c,f_col_)
while (rgl.cur() > 0) { rgl.close() }
for(what in names(f_col)){
  col=rainbow(max(f_col[[what]])*1.2)[1:max(f_col[[what]])]
  f_col_=f_col[[what]]
  tcga=grep("TCGA",rownames(k))
  ## 2D
  plot(pc$layout[-tcga,],col =col[f_col_[-tcga]],pch=20,cex=0.175,main=what, xlab="", ylab="")
  points(pc$layout[tcga,],col ="black",pch=20,cex=2.5)
  if(what=="sample"){
    legend("topright", legend = names(landscape)[-length(landscape)], pch = 16, col = col, cex=1)
  }else{
    colorbar.plot( 15, 17, seq(quantile(f_col_,0),quantile(f_col_,1),by=1), horizontal=T, col=col) 
  }
  ### 3D
  # rgl.open()
  # par3d(windowRect=c(0,0,500,500))
  # rgl::plot3d(pc$layout[-tcga,],col =col[f_col_[-tcga]],pch=20,cex=0.5,main=what, xlab="", ylab="", zlab="")
  # rgl::plot3d(pc$layout[tcga,],col =col[f_col_[tcga]],pch=20,cex=0.5,add=T,type='s',size=1.5)
  # if(what=="sample"){
  #   legend3d("topright", legend = names(landscape), pch = 16, col = col, cex=1, inset=c(0.02))
  # }else{
  #   rgl::bgplot3d(fields::image.plot(legend.only = TRUE, zlim = range(f_col_), col = col) )
  # }
  # rgl::par3d(mouseMode = c("none", "polar", "fov", "zoom", "pull"))
}
# save(file="~/Downloads/pca.RObj",list = c("pc"))
```


Check if identical karyotypes from different landscapes have comparable fitness.
```{r}
## SA609rx2 excluded because it has overall very low fitness -- is everything all right with that sample?
ii=setdiff(1:nrow(k),grep("SA609rx2",rownames(k)))
ii=setdiff(ii,grep("TCGA",rownames(k)))
la=apply(k[ii,],1,function(x) paste(x, collapse = "."));
frequentKaryo=plyr::count(la)
print(paste(nrow(frequentKaryo),"unique karyotypes represented across",length(landscape),"landscapes"))

tmp=hist(frequentKaryo$freq);
barplot(tmp$counts[tmp$counts>0],log="y",xlab="# fitness landscapes with karyotype", ylab="# karyotypes", col="cyan",names.arg = round(tmp$mids[tmp$counts>0]));
frequentKaryo=frequentKaryo[order(frequentKaryo$freq,decreasing = T),]
frequentKaryo=frequentKaryo$x[frequentKaryo$freq>=3]
frequentKaryo_F=sapply(frequentKaryo, function(x) f[ii][which(x==la)])
frequentKaryo_F=frequentKaryo_F[order(sapply(frequentKaryo_F, median))];
par(mai=c(0.95,4,0.5,0.5))
boxplot(frequentKaryo_F,horizontal = T,las=2, xlab="predicted fitness", main="Intra- vs inter-karyotype heterogeneity in fitness",col="cyan")

## @TODO: can we group landscapes according to how similar the selective pressure that shaped them is?
```

Breast cancer: Use landscape that is closest to a given TCGA sample for forward sims:
```{r}
dist=flexclust::dist2(pc$layout[tcga,], pc$layout[-tcga,])
closest= rownames(k[-tcga])[apply(dist,1,which.min)]
closest= sapply(strsplit(closest,".",fixed = T), "[[",1)
names(closest)=gsub("TCGA.","",rownames(k)[tcga],fixed = T)
print(plyr::count(closest))

print("Closest distance to SA609ln1 landscape:")
soi=sort(apply(dist,1,min)[match(names(closest)[closest=="SA609ln1"],gsub("TCGA.","",rownames(dist),fixed = T))])
names(soi)=gsub("TCGA.","",names(soi),fixed=T)
print(soi)

## Run ABM using closest fitness landscape and TCGA karyotype as initial condition
for(i in rownames(landscape$TCGA$k)){
  # for(i in names(soi)){
  OUTD=paste0(ALFAK_SIMS,filesep,i)
  dir.create(paste0(OUTD,"/custom_pop/"), recursive=TRUE)
  # if(file.exists(paste0(OUTD,"/custom_pop/",i))){
  #   next;
  # }
  print(paste("Simulating", i))
  unlink(paste0(OUTD,"/custom_pop/",i), recursive=TRUE)
    
  ## find karyotype represented in landscape that is closest to TCGA karyotype
  dd=flexclust::dist2(k[grep("TCGA",rownames(k),invert = T),],landscape$TCGA$k[i,,drop=F])
  # pop <- landscape$TCGA$k[i,1:22]
  tcga_proxy=rownames(k)[which.min(dd)]
  pop <- k[tcga_proxy,]
  n_init <- c(5000)
  pop <- cbind(pop,n_init)
  write.table(pop,paste0(OUTD,"/custom_pop.txt"),sep=",",row.names = F,col.names = F)
  
  ## plot landscape and location of current TCGA sample:
  f_col=landscape[[closest[i]]]$f*100
  f_col = 1+ f_col- min(f_col)
  col=rainbow(max(f_col)*1.2)[1:max(f_col)]
  plot(pc$layout[grep(closest[i],rownames(pc$layout)),],col=col[f_col],pch=20,cex=0.175, xlab="", ylab="", main=i)
  tcga=c(grep(i,rownames(pc$layout)), which(tcga_proxy==rownames(pc$layout)))
  points(pc$layout[tcga,1],pc$layout[tcga,2],col =c("gray","black"),pch=20,cex=1.5)
  colorbar.plot( 7,-15, seq(quantile(f_col,0),quantile(f_col,1),by=1), horizontal=T, col=col) 

  config <- readLines(paste0(ALFAK_SIMS,filesep,"config.txt"))
  config <- c(config,paste0("population_file,",OUTD,"/custom_pop.txt"))
  config <- modify_config("output_dir",paste0(OUTD,"/custom_pop"),config)
  config <- modify_config("fitness_landscape_file",paste0(tnbc[closest[i]],"/fitted_landscape.txt"),config)
  config <- modify_config("fitness_landscape_type","krig",config)
  config <- modify_config("Nsteps","10430",config)
  # config <- modify_config("p,","0.0005",config); ## Doesn't work atm
  config[grepl("p,", config)] = "p,0.0001"
  writeLines(config,paste0(OUTD,"/custom_pop_config.txt"))
  
  system(paste0("~/Repositories/ALFA-K/ABM/bin/ABM ",OUTD,"/custom_pop_config.txt"))
  file.rename(paste0(OUTD,"/custom_pop/00000"),paste0(OUTD,"/custom_pop/",i))
  
  ## Visualize sims
  # landscape_i=viewEvolutionOnLandscape(simulationOutput=paste0(OUTD,"/custom_pop/",i), landscape=NULL, path2landscape=tnbc[closest[i]], path2gifoutput=paste0("~/Downloads/",i))
}
```



Breast cancer: Compare trajectories taken by different initial karyotype configurations across the different landscapes
```{r}
gc=list()
for(whichSample in rownames(landscape$TCGA$k)){
  OUTD=paste0(ALFAK_SIMS,filesep,whichSample)
  files=list.files(paste0(OUTD,"/custom_pop/"),full.names = T,pattern = "TCGA")
  
  for(d in files){
    dd=list.files(d, pattern = ".csv",full.names = T)
    if(length(dd)<3){
      next
    }
    x=sapply(dd, read.csv,simplify = F)
    
    x=x[-1]; ## exclude time 0
    x= sapply(x, function(y) y[,-c(1:22)],simplify = F)
    maxGr= sapply(x, function(y) max(y[,2]))
    x= sapply(x, function(y) (y[,1]/sum(y[,1]))*y[,2],simplify = F)
    meanGr = sapply(x,sum)
    x=cbind(meanGr,maxGr,as.numeric(gsub(".csv","",sapply(names(x), function(y) fileparts(y)$name))))
    x=as.data.frame(x)
    colnames(x)=c("growth_rate_Mean","growth_rate_Max","time")
    x$name=fileparts(d)$name
    gc[[x$name[1]]]=x
    plot(x$time,x$growth_rate_Mean, main=x$name[1], xlab="Generation", ylab="Population fitness (average across all karyotypes)",pch=20)
  }
}
gr_popmax=sapply(gc, function(x) max(x$growth_rate_Max))
gr_popmean=sapply(gc, function(x) mean(x$growth_rate_Mean))
gr_popacc = sapply(gc, function(x) lm(x$growth_rate_Mean~x$time)$coefficients[2])
names(gr_popacc)=gsub(".x$time","",names(gr_popacc),fixed = T)
barplot(gr_popacc,horiz = T,las=2,names.arg = names(gc))
gc=do.call(rbind,gc)
ggplot(gc, aes(x=time, y=growth_rate_Mean)) + 
  geom_line(aes(colour=name, group=name)) +
  geom_point(aes(colour=name),size=3)    
```



Breast cancer: Can inferred growth dynamics features predict survival?
```{r}
surv=read.table("../data/patients/TCGA/TNBC/nationwidechildrens.org_clinical_patient_brca.txt",sep="\t", header=T,fill = T)
surv$pathologic_stage_short=gsub("C","",gsub("B","",gsub("A","",surv$ajcc_pathologic_tumor_stage)))
## Consider only TCGA samples within reasonable distance to at least 1 known landscape
soi= rownames(landscape$TCGA$k); 

surv=surv[surv$bcr_patient_barcode %in% soi,] 
rownames(surv)=surv$bcr_patient_barcode
plyr::count(surv[soi,]$ajcc_pathologic_tumor_stage)
plyr::count(surv[soi,]$pathologic_stage_short)

boxplot(gr_popacc[soi]~ surv[soi,]$ajcc_pathologic_tumor_stage)
boxplot(gr_popmean[soi]~ surv[soi,]$ajcc_pathologic_tumor_stage)
boxplot(gr_popmean[soi]~ surv[soi,]$pathologic_stage_short, xlab="pathologic stage", ylab="Predicted fitness")
boxplot(gr_popmax[soi]~ surv[soi,]$pathologic_stage_short, xlab="pathologic stage", ylab="Predicted fitness")
anova(lm(gr_popmean[soi]~ surv[soi,]$pathologic_stage_short))
```

